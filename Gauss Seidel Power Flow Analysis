linedata=[1 2 15 0.0303 0.0999 0.0127 2
1 3 48 0.0129 0.0424 0.00541 2
4 5 129 0.00176 0.00798 0.00105 2
3 5 85 0.0241 0.108 0.0142 4
5 6 111 0.0119 0.054 0.00713 2
6 7 44 0.00459 0.0208 0.00275 2
8 9 551 0.00244 0.0305 0.581 2
8 5 423 0 0.0267 0 4
9 10 557 0.00258 0.0322 0.615 2
4 11 80 0.0209 0.0688 0.00874 2
5 11 97 0.0203 0.0682 0.00869 2
11 12 43 0.00595 0.0196 0.00251 2
2 12 41 0.0187 0.0616 0.00786 4
3 12 12 0.0484 0.16 0.0203 4
7 12 21 0.00862 0.034 0.00437 4
11 13 44 0.02225 0.0731 0.00938 2
12 14 23 0.0215 0.0707 0.00908 2
13 15 1 0.0744 0.2444 0.03134 2
14 15 5 0.0595 0.195 0.0251 4
12 16 9 0.0212 0.0834 0.0107 2
15 17 130 0.0132 0.0437 0.0222 2
16 17 22 0.0454 0.1801 0.0233 4
17 18 100 0.0123 0.0505 0.00649 2
18 19 24 0.01119 0.0493 0.00571 2
19 20 13 0.0252 0.117 0.0149 2
15 19 14 0.012 0.0394 0.00505 4
20 21 36 0.0183 0.0849 0.0108 2
21 22 54 0.0209 0.097 0.0123 2
22 23 67 0.0342 0.159 0.0202 2
23 24 10 0.0135 0.0492 0.0249 2
23 25 203 0.0156 0.08 0.0432 2
26 25 113 0 0.0382 0 2
25 27 179 0.0318 0.163 0.0882 2
27 28 41 0.01913 0.0855 0.0108 2
28 29 20 0.0237 0.0943 0.0119 2
30 17 289 0 0.0388 0 2
8 30 93 0.00431 0.0504 0.257 4
26 30 280 0.00799 0.086 0.454 4
17 31 18 0.0474 0.1563 0.01995 2
29 31 11 0.0108 0.0331 0.00415 4
23 32 116 0.0317 0.1153 0.05865 2
31 32 37 0.0298 0.0985 0.01255 4
27 32 16 0.0229 0.0755 0.00963 4
15 33 9 0.038 0.1244 0.01597 2
19 34 4 0.0752 0.247 0.0316 2
35 36 1 0.00224 0.0102 0.00134 2
35 37 42 0.011 0.0497 0.00659 2
33 37 20 0.0415 0.142 0.0183 4
34 36 38 0.00871 0.0268 0.00284 4
34 37 118 0.00256 0.0094 0.00492 4
38 37 304 0 0.0375 0 2
37 39 69 0.0321 0.106 0.0135 2
37 40 55 0.0593 0.168 0.021 2
30 38 78 0.00464 0.054 0.211 4
39 40 34 0.0184 0.0605 0.00776 4
40 41 19 0.0145 0.0487 0.00611 2
40 42 15 0.0555 0.183 0.0233 2
41 42 27 0.041 0.135 0.0172 4
43 44 21 0.0608 0.2454 0.03034 2
34 43 2 0.0413 0.1681 0.02113 4
44 45 41 0.0224 0.0901 0.0112 2
45 46 45 0.04 0.1356 0.0166 2
46 47 39 0.038 0.127 0.0158 2
46 48 18 0.0601 0.189 0.0236 2
47 49 12 0.0191 0.0625 0.00802 2
42 49 81 0.0715 0.323 0.043 4
42 49 81 0.0715 0.323 0.043 4
45 49 62 0.0684 0.186 0.0222 4
48 49 44 0.0179 0.0505 0.00629 4
49 50 67 0.0267 0.0752 0.00937 2
49 51 83 0.0486 0.137 0.0171 2
51 52 36 0.0203 0.0588 0.00698 2
52 53 13 0.0405 0.1635 0.02029 2
53 54 16 0.0263 0.122 0.0155 2
49 54 47 0.073 0.289 0.0369 4
49 54 47 0.0869 0.291 0.0365 4
54 55 9 0.0169 0.0707 0.0101 2
54 56 23 0.00275 0.00955 0.00366 2
55 56 27 0.00488 0.0151 0.00187 4
56 57 29 0.0343 0.0966 0.0121 2
50 57 45 0.0474 0.134 0.0166 4
56 58 8 0.0343 0.0966 0.0121 2
51 58 23 0.0255 0.0719 0.00894 4
54 59 38 0.0503 0.2293 0.0299 2
56 59 35 0.0825 0.251 0.02845 4
56 59 37 0.0803 0.239 0.0268 4
55 59 43 0.04739 0.2158 0.02823 4
59 60 54 0.0317 0.145 0.0188 2
59 61 65 0.0328 0.15 0.0194 2
60 61 140 0.00264 0.0135 0.00728 4
60 62 12 0.0123 0.0561 0.00734 2
61 62 32 0.00824 0.0376 0.0049 4
63 59 190 0 0.0386 0 2
63 64 190 0.00172 0.02 0.108 2
64 61 38 0 0.0268 0 4
38 65 227 0.00901 0.0986 0.523 2
64 65 228 0.00269 0.0302 0.19 4
49 66 165 0.018 0.0919 0.0124 2
49 66 165 0.018 0.0919 0.0124 4
62 66 46 0.0482 0.218 0.0289 4
62 67 30 0.0258 0.117 0.0155 2
65 66 11 0 0.037 0 4
66 67 66 0.0224 0.1015 0.01341 4
65 68 18 0.00138 0.016 0.319 2
47 69 70 0.0844 0.2778 0.03546 2
49 69 58 0.0985 0.324 0.0414 4
68 69 157 0 0.037 0 4
69 70 135 0.03 0.127 0.061 2
24 70 8 0.00221 0.4115 0.05099 4
70 71 21 0.00882 0.0355 0.00439 2
24 72 2 0.0488 0.196 0.0244 2
71 72 13 0.0446 0.18 0.02222 4
71 73 8 0.00866 0.0454 0.00589 2
70 74 20 0.0401 0.1323 0.01684 2
70 75 1 0.0428 0.141 0.018 2
69 75 138 0.0405 0.122 0.062 4
74 75 65 0.0123 0.0406 0.00517 4
76 77 76 0.0444 0.148 0.0184 2
69 77 78 0.0309 0.101 0.0519 4
75 77 43 0.0601 0.1999 0.02489 4
77 78 57 0.00376 0.0124 0.00632 2
78 79 32 0.00546 0.0244 0.00324 2
77 80 121 0.017 0.0485 0.0236 2
77 80 55 0.0294 0.105 0.0114 4
79 80 81 0.0156 0.0704 0.00935 4
68 81 55 0.00175 0.0202 0.404 2
81 80 55 0 0.037 0 4
77 82 4 0.0298 0.0853 0.04087 2
82 83 59 0.0112 0.03665 0.01898 2
83 84 31 0.0625 0.132 0.0129 2
83 85 53 0.043 0.148 0.0174 2
84 85 45 0.0302 0.0641 0.00617 4
85 86 21 0.035 0.123 0.0138 2
86 87 5 0.02828 0.2074 0.02225 2
85 88 63 0.02 0.102 0.0138 2
85 89 89 0.0239 0.173 0.0235 2
88 89 124 0.0139 0.0712 0.00967 4
89 90 73 0.0518 0.188 0.0264 2
89 90 139 0.0238 0.0997 0.053 4
90 91 2 0.0254 0.0836 0.0107 2
89 92 252 0.0099 0.0505 0.0274 2
89 92 79 0.0393 0.1581 0.0207 4
91 92 11 0.0387 0.1272 0.01634 4
92 93 72 0.0258 0.0848 0.0109 2
92 94 65 0.0481 0.158 0.0203 2
93 94 56 0.0223 0.0732 0.00938 4
94 95 51 0.0132 0.0434 0.00555 2
80 96 24 0.0356 0.182 0.0247 2
82 96 12 0.0162 0.053 0.0272 4
94 96 25 0.0269 0.0869 0.0115 4
80 97 33 0.0183 0.0934 0.0127 2
80 98 36 0.0238 0.108 0.0143 2
80 99 24 0.0454 0.206 0.0273 2
92 100 39 0.0648 0.295 0.0236 2
94 100 5 0.0178 0.058 0.0302 4
95 96 2 0.0171 0.0547 0.00737 4
96 97 14 0.0173 0.0885 0.012 4
98 100 7 0.0397 0.179 0.0238 4
99 100 28 0.018 0.0813 0.0108 4
100 101 21 0.0277 0.1262 0.0164 2
92 102 56 0.0123 0.0559 0.00732 2
101 102 49 0.0246 0.112 0.0147 4
100 103 152 0.016 0.0525 0.0268 2
100 104 70 0.0451 0.204 0.02705 2
103 104 41 0.0466 0.1584 0.02035 4
103 105 54 0.0535 0.1625 0.0204 2
100 106 75 0.0605 0.229 0.031 2
104 105 61 0.00994 0.0378 0.00493 4
105 106 11 0.014 0.0547 0.00717 4
105 107 33 0.053 0.183 0.0236 2
105 108 30 0.0261 0.0703 0.00922 2
106 107 30 0.053 0.183 0.0236 4
108 109 27 0.0105 0.0288 0.0038 2
103 110 76 0.03906 0.1813 0.02305 2
109 110 17 0.0278 0.0762 0.0101 4
110 111 45 0.022 0.0755 0.01 2
110 112 87 0.0247 0.064 0.031 2
17 113 3 0.00913 0.0301 0.00384 2
32 113 5 0.0615 0.203 0.0259 4
32 114 12 0.0135 0.0612 0.00814 2
27 115 26 0.0164 0.0741 0.00986 2
114 115 2 0.0023 0.0104 0.00138 4
68 116 230 0.00034 0.00405 0.082 2
12 117 25 0.0329 0.14 0.0179 2
75 118 50 0.0145 0.0481 0.00599 2
76 118 9 0.0164 0.0544 0.00678 4];
a=size(linedata);
ne=a(1,1);
nb=max(max(linedata(:,1),linedata(:,2)));
z=complex(linedata(:,4),linedata(:,5));

zbus=zeros(nb);

for i=1:nb 
    if linedata(i,7)==1
        zbus(linedata(i,2),linedata(i,2)) = z(i);
    end
    if linedata(i,7)==2
        t = linedata(i,2);
        f = linedata(i,1);
        for v = 1:f-1
            zbus(t,v) = zbus(f,v);
        end
        for v = 1:f-1
            zbus(v,t) = zbus(v,f);
        end
        zbus(t,t) = zbus(f,f) + z(i);
    end
    if linedata(i,7)==3
        if(linedata(i,1))~=0
            f = linedata(i,1);
        else
            f = linedata(i,2);
        end
        zbus1 = zbus(:,f);
        zbus2 = zbus(f,:);
        zb = zbus(f,f) + z(i);
        zbus1 = zbus1.*zbus2;
        zbus1 = zbus1*(1/zb);
        zbus = zbus - zbus1;
    end
    if linedata(i,7)==4
        f = linedata(i,1);
        t = linedata(i,2);
        zbus1= [];
        zbus1 = [zbus1 zeros(1,length(zbus))];
        for v=1:length(zbus)
            zbus1(v) = zbus(f,v)-zbus(t,v);
        end
        zbus2 = zbus1';
        zb = zbus(f,f)+zbus(t,t)+z(i)-(2*zbus(f,t));
        zbus1 = zbus1.*zbus2;
        zbus1 = zbus1*(1/zb);
        zbus = zbus-zbus1;
    end
end
zbus

y=1./z;
ysh=linedata(:,5);
ysh=ysh.*j;
ybus=zeros(nb);
for count=1:ne
    count;
    i=linedata(count,1);
    k=linedata(count,2);
    if(i==0)&&(k~=0)
        ybus(k,k)=ybus(k,k)+y(count)+0.5*ysh(count);
    end
     if(i~=0)&&(k==0)
        ybus(i,i)=ybus(i,i)+y(count)+0.5*ysh(count);
    end
    if(i~=0)&&(k~=0)
        ybus(i, i) = ybus(i, i) +(y(count) + 0.5*ysh(count));
        ybus(i, k) = ybus(i, k) - y(count);
        ybus(k, i) = ybus(k, i) - y(count);
        ybus(k, k) = ybus(k, k) + y(count) + 0.5*ysh(count);
    end   
end
ybus
% Bus No.|Bus Type | Voltage(p.u.)|P.gen(p.u.)|P.load(p.u.)|Q.load(p.u.)
%         1) Slack
%         2) Load
%         3) Generating
busdata = [1 3 0.955 0 0.51 0.27
2 2 0.971 0 0.2 0.09
3 2 0.968 0 0.39 0.1
4 3 0.998 0 0.39 0.12
5 2 1.002 0 0 0
6 3 0.99 0 0.52 0.22
7 2 0.989 0 0.19 0.02
8 3 1.015 0 0.28 0
9 2 1.043 0 0 0
10 3 1.05 4.5 0 0
11 2 0.985 0 0.7 0.23
12 3 0.99 0.85 0.47 0.1
13 2 0.968 0 0.34 0.16
14 2 0.984 0 0.14 0.01
15 3 0.97 0 0.9 0.3
16 2 0.984 0 0.25 0.1
17 2 0.995 0 0.11 0.03
18 3 0.973 0 0.6 0.34
19 3 0.963 0 0.45 0.25
20 2 0.958 0 0.18 0.03
21 2 0.959 0 0.14 0.08
22 2 0.97 0 0.1 0.05
23 2 1 0 0.07 0.03
24 3 0.992 0 0.13 0
25 3 1.05 2.2 0 0
26 3 1.015 3.14 0 0
27 3 0.968 0 0.71 0.13
28 2 0.962 0 0.17 0.07
29 2 0.963 0 0.24 0.04
30 2 0.968 0 0 0
31 3 0.967 0.07 0.43 0.27
32 3 0.964 0 0.59 0.23
33 2 0.972 0 0.23 0.09
34 3 0.986 0 0.59 0.26
35 2 0.981 0 0.33 0.09
36 3 0.98 0 0.31 0.17
37 2 0.992 0 0 0
38 2 0.962 0 0 0
39 2 0.97 0 0.27 0.11
40 3 0.97 0 0.66 0.23
41 2 0.967 0 0.37 0.1
42 3 0.985 0 0.96 0.23
43 2 0.978 0 0.18 0.07
44 2 0.985 0 0.16 0.08
45 2 0.987 0 0.53 0.22
46 3 1.005 0.19 0.28 0.1
47 2 1.017 0 0.34 0
48 2 1.021 0 0.2 0.11
49 3 1.025 2.04 0.87 0.3
50 2 1.001 0 0.17 0.04
51 2 0.967 0 0.17 0.08
52 2 0.957 0 0.18 0.05
53 2 0.946 0 0.23 0.11
54 3 0.955 0.48 1.13 0.32
55 3 0.952 0 0.63 0.22
56 3 0.954 0 0.84 0.18
57 2 0.971 0 0.12 0.03
58 2 0.959 0 0.12 0.03
59 3 0.985 1.55 2.77 1.13
60 2 0.993 0 0.78 0.03
61 3 0.995 1.6 0 0
62 3 0.998 0 0.77 0.14
63 2 0.969 0 0 0
64 2 0.984 0 0 0
65 3 1.005 3.91 0 0
66 3 1.05 3.92 0.39 0.18
67 2 1.02 0 0.28 0.07
68 2 1.003 0 0 0
69 1 1.035 5.164 0 0
70 3 0.984 0 0.66 0.2
71 2 0.987 0 0 0
72 3 0.98 0 0.12 0
73 3 0.991 0 0.06 0
74 3 0.958 0 0.68 0.27
75 2 0.967 0 0.47 0.11
76 3 0.943 0 0.68 0.36
77 3 1.006 0 0.61 0.28
78 2 1.003 0 0.71 0.26
79 2 1.009 0 0.39 0.32
80 3 1.04 4.77 1.3 0.26
81 2 0.997 0 0 0
82 2 0.989 0 0.54 0.27
83 2 0.985 0 0.2 0.1
84 2 0.98 0 0.11 0.07
85 3 0.985 0 0.24 0.15
86 2 0.987 0 0.21 0.1
87 3 1.015 0.04 0 0
88 2 0.987 0 0.48 0.1
89 3 1.005 6.07 0 0
90 3 0.985 0 1.63 0.42
91 3 0.98 0 0.1 0
92 3 0.993 0 0.65 0.1
93 2 0.987 0 0.12 0.07
94 2 0.991 0 0.3 0.16
95 2 0.981 0 0.42 0.31
96 2 0.993 0 0.38 0.15
97 2 1.011 0 0.15 0.09
98 2 1.024 0 0.34 0.08
99 3 1.01 0 0.42 0
100 3 1.017 2.52 0.37 0.18
101 2 0.993 0 0.22 0.15
102 2 0.991 0 0.05 0.03
103 3 1.001 0.4 0.23 0.16
104 3 0.971 0 0.38 0.25
105 3 0.965 0 0.31 0.26
106 2 0.962 0 0.43 0.16
107 3 0.952 0 0.5 0.12
108 2 0.967 0 0.02 0.01
109 2 0.967 0 0.08 0.03
110 3 0.973 0 0.39 0.3
111 3 0.98 0.36 0 0
112 3 0.975 0 0.68 0.13
113 3 0.993 0 0.06 0
114 2 0.96 0 0.08 0.03
115 2 0.96 0 0.22 0.07
116 3 1.005 0 1.84 0
117 2 0.974 0 0.2 0.08
118 2 0.949 0 0.33 0.15];
 %**calculation of  bus voltage and power**
v=busdata(:,3);                % Voltage
theta = [];             
iteration= 0;                   % Iteration is starting
tolerance=1;                    % Tolerence is intialized as 1 
type=busdata(:,2);
slack = 0;
for i = 1:nb
    if type(i) == 1
        slack = i;
    end
%     if type(i) == 2
%         v(i) = 1;
%     end
    theta(i)=0;
end
vnew = v;
pdelta = zeros(nb,1);
qdelta = zeros(nb,1);
sum1 = 1;
toler = [];
ybus(1,1)
sum1 = 0;
for i = 1:nb
    if type(i)==2
        pdelta(i) = busdata(i,4)-busdata(i,5);
        qdelta(i) = -busdata(i,6);
    end
    if type(i)==3
        pdelta(i) = busdata(i,4)-busdata(i,5);
        for k = 1:nb
            if real(ybus(i,k))~=0
                delta = atan(imag(ybus(i,k))/real(ybus(i,k)));
            else
                delta = 0;
            end
                sum1 = sum1 + v(i)*v(k)*ybus(i,k)*sin(delta + theta(k) - theta(i));
%               sum1 = sum1 + vnew(k)*(real(ybus(i,k))*sin(delta)-imag(ybus(i,k))*cos(delta));
        end
        qdelta(i) = -sum1;
    end
    sum1 = 1;
end
while (tolerance > 0.0001)
sum1=0;
j=sqrt(-1);
for i = 1:nb
    if type(i)==2
        for k = 1:nb
            if k~=i
                sum1 = sum1+ybus(i,k)*vnew(k);
            end
        end
%        vnew(i)=(((conj(complex(pdelta(i),qdelta(i))))/conj(v(i)))-sum1);
        vnew(i)=(((pdelta(i) - qdelta(i)*j)/conj(vnew(i)))-sum1)/ybus(i,i);
        theta(i) = imag(vnew(i))/real(vnew(i));
        sum1 = 0;
    end    
end
tolerance= max(abs(abs(vnew) - abs(v)))
for i = 1:nb
    if type(i)==3
        for k = 1:nb
            if type(k)~=1
                if ybus(i,k)~=0
                    delta = atan(imag(ybus(i,k))/real(ybus(i,k)));
                else
                    delta = 0;
                end
                sum1 = sum1 + v(i)*v(k)*ybus(i,k)*sin(delta + theta(k) - theta(i));
%               sum1 = sum1 + vnew(k)*(real(ybus(i,k))*sin(delta)-imag(ybus(i,k))*cos(delta));
            end
        end
        qdelta(i) = -sum1;
        sum1 = 0;
    end
end
v = vnew;
toler = [toler tolerance]
iteration=iteration+1;
end
iteration
vnew
tolerance;
sum2=0;
MVA_base = 100;
for i=1:nb % To find the slack power
     sum2=sum2+ybus(i,slack)*v(i);
    end
s=conj(vnew(slack))*sum2 %Slack Power
P=real(s)*MVA_base
Q=-imag(s)*MVA_base
iter = 1:iteration;
stem(iter,toler)
